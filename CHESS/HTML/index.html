<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess Compass</title>

<style>
/* [ALL YOUR EXISTING CSS STAYS EXACTLY THE SAME] */
body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#0f1224;
    color:#fff;
}

.header{
    background:#1e3c72;
    padding:20px;
    text-align:center;
    font-size:26px;
    font-weight:bold;
}

.sub{
    font-size:14px;
    opacity:0.9;
}

.main{
    display:flex;
    justify-content:center;
    gap:40px;
    padding:30px;
}

/* BOARD */
.board-wrap{
    position:relative;
    background:#1b1e30;
    padding:20px;
    border-radius:10px;
}

table{
    border-collapse:collapse;
    border:4px solid #333;
    position:relative;
    z-index:1;
}

td{
    width:70px;
    height:70px;
    text-align:center;
    vertical-align:middle;
    font-size:40px;
    cursor:pointer;
}

.light{ background:#f0d9b5; }
.dark{ background:#b58863; }

.white-piece{ color:white; }
.black-piece{ color:black; }

.selected{ outline:4px solid #ff4444; }

/* TROPHY OVERLAY */
#trophy-overlay{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:999;
}

#trophy-overlay .trophy{
    font-size:120px;
}

#trophy-overlay .winner{
    font-size:30px;
    margin-top:15px;
    font-weight:bold;
}

/* SIDE */
.side{
    width:260px;
    background:#1b1e30;
    padding:20px;
    border-radius:10px;
}

.box{
    background:#2a2d44;
    padding:15px;
    border-radius:6px;
    margin-bottom:15px;
    text-align:center;
}

.btn{
    width:100%;
    padding:10px;
    margin-top:8px;
    border:none;
    border-radius:6px;
    background:#3a6df0;
    color:white;
    font-size:16px;
    cursor:pointer;
}

.btn:hover{ background:#2f5bd4; }

#check-status{
    color:#ff5252;
    margin-top:8px;
    font-weight:bold;
}

/* Share link styles - UPDATED FOR CLICKABLE LINKS */
#share-link-container {
    margin-top: 15px;
    display: none;
}

.share-link {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    background: #1b1e30;
    border: 2px solid #3a6df0;
    color: #3a6df0 !important;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none !important;
    word-break: break-all;
    display: block;
    text-align: center;
    font-weight: bold;
    transition: all 0.3s;
}

.share-link:hover {
    background: #2a2d44;
    text-decoration: underline !important;
    transform: scale(1.02);
}

.share-info {
    font-size: 12px;
    color: #aaa;
    margin-top: 5px;
}

.game-id-display {
    background: #3a6df0;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: bold;
    margin: 10px 0;
    display: inline-block;
    color: white;
}

/* Player info */
.player-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
}

.player-you {
    color: #4CAF50;
    font-weight: bold;
}

.player-opponent {
    color: #FF5722;
}

.connection-status {
    font-size: 12px;
    margin-top: 5px;
    color: #aaa;
}

.connected {
    color: #4CAF50 !important;
}

.disconnected {
    color: #FF5252 !important;
}

/* Modal for connection */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #1b1e30;
    padding: 20px;
    border-radius: 10px;
    width: 320px;
    text-align: center;
}

.code-display {
    background: #000;
    color: #0f0;
    padding: 15px;
    font-family: monospace;
    font-size: 24px;
    letter-spacing: 5px;
    margin: 15px 0;
    border-radius: 5px;
}

.code-input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 2px solid #3a6df0;
    background: #0f1224;
    color: white;
    border-radius: 5px;
    font-size: 18px;
    text-align: center;
    letter-spacing: 3px;
}

/* Share buttons */
.share-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.share-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    font-size: 14px;
}

.whatsapp { background: #25D366; }
.telegram { background: #0088cc; }
.copy { background: #3a6df0; }

/* Mobile responsiveness */
@media (max-width: 768px) {
    .main {
        flex-direction: column;
        padding: 10px;
        gap: 20px;
    }
    
    td {
        width: 40px;
        height: 40px;
        font-size: 30px;
    }
    
    .board-wrap {
        padding: 10px;
    }
    
    .side {
        width: 100%;
    }
    
    .header {
        padding: 15px;
        font-size: 20px;
    }
}
</style>
</head>

<body>

<div class="header">
    ‚ôî CHESS COMPASS ‚ôö
    <div class="sub">Legal Chess Moves - Click pieces to play</div>
</div>

<div class="main">
    <div class="board-wrap">

        <!-- TROPHY -->
        <div id="trophy-overlay">
            <div class="trophy">üèÜ</div>
            <div class="winner" id="winner-text"></div>
        </div>

        <table id="board"></table>
    </div>

    <div class="side">
        <div class="box">
            <div id="game-info">White's Turn</div>
            <div id="check-status"></div>
            <hr>
            <div id="white-moves">White Moves: 0</div>
            <div id="black-moves">Black Moves: 0</div>
            
            <div class="player-info">
                <span class="player-you" id="player-you">You: White</span>
                <span class="player-opponent" id="player-opponent">Opponent: Black</span>
            </div>
            <div class="connection-status" id="connection-status">Playing Locally</div>
        </div>

        <div class="box">
            <button class="btn" onclick="startNewGame()">New Game</button>
            <button class="btn" onclick="undoMove()">Undo Move</button>
            <button class="btn" onclick="initBoard()">Reset Board</button>
            <button class="btn" onclick="createMultiplayerGame()">Play with Friend</button>
            
            <div id="share-link-container">
                <div style="color: #4CAF50; font-weight: bold; margin: 10px 0;">‚úì Game Created!</div>
                <div>Send this link to your friend:</div>
                
                <!-- THE FIXED CLICKABLE LINK -->
                <a href="#" id="clickable-game-link" class="share-link" target="_blank">
                    üéÆ CLICK HERE TO JOIN GAME
                </a>
                
                <div class="share-info">Your friend just needs to click this link!</div>
                <div>Or share this code:</div>
                <div class="game-id-display" id="game-id-display"></div>
                
                <div class="share-buttons">
                    <button class="share-btn whatsapp" onclick="shareViaWhatsApp()">WhatsApp</button>
                    <button class="share-btn telegram" onclick="shareViaTelegram()">Telegram</button>
                    <button class="share-btn copy" onclick="copyShareLink()">Copy Link</button>
                </div>
            </div>
        </div>
        
        <div class="box">
            <button class="btn" onclick="showJoinModal()">Join Friend's Game</button>
            <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                Or click the link your friend sends you
            </div>
        </div>
    </div>
</div>

<!-- Connection Modal -->
<div class="modal" id="connection-modal">
    <div class="modal-content">
        <h3>Connect to Friend</h3>
        <div id="modal-content-area">
            <!-- Content will be inserted here -->
        </div>
        <button class="btn" onclick="hideModal()" style="margin-top: 10px;">Cancel</button>
    </div>
</div>

<script>
// ====================
// GAME VARIABLES - SAME AS BEFORE
// ====================
let board = [];
let currentPlayer = "white";
let selected = null;
let gameOver = false;
let history = [];
let whiteMoves = 0;
let blackMoves = 0;
let playerColor = "white";
let isMultiplayer = false;
let currentGameCode = null;
let peer = null;
let conn = null;
let shareableUrl = null;

const pieces = {
    white: {king: "‚ôî", queen: "‚ôï", rook: "‚ôñ", bishop: "‚ôó", knight: "‚ôò", pawn: "‚ôô"},
    black: {king: "‚ôö", queen: "‚ôõ", rook: "‚ôú", bishop: "‚ôù", knight: "‚ôû", pawn: "‚ôü"}
};

// ====================
// GAME INITIALIZATION - SAME AS BEFORE
// ====================
function initBoard() {
    board = [
        makeRow("black", "rook", "knight", "bishop", "queen", "king", "bishop", "knight", "rook"),
        makePawnRow("black"),
        Array(8).fill(null),
        Array(8).fill(null),
        Array(8).fill(null),
        Array(8).fill(null),
        makePawnRow("white"),
        makeRow("white", "rook", "knight", "bishop", "queen", "king", "bishop", "knight", "rook")
    ];
    currentPlayer = "white";
    selected = null;
    gameOver = false;
    history = [];
    whiteMoves = 0;
    blackMoves = 0;
    playerColor = "white";
    
    // Close any existing connections
    if (conn) {
        conn.close();
        conn = null;
    }
    if (peer) {
        peer.destroy();
        peer = null;
    }
    
    isMultiplayer = false;
    currentGameCode = null;
    shareableUrl = null;
    
    document.getElementById("trophy-overlay").style.display = "none";
    document.getElementById("share-link-container").style.display = "none";
    document.getElementById("connection-status").textContent = "Playing locally";
    document.getElementById("connection-status").className = "connection-status";
    
    drawBoard();
    updateInfo();
    document.getElementById("check-status").textContent = "";
    updatePlayerInfo();
}

function startNewGame() {
    if (isMultiplayer && currentGameCode) {
        if (confirm("Leave multiplayer game and start local game?")) {
            initBoard();
        }
    } else {
        initBoard();
    }
}

function makeRow(color, ...t) { return t.map(x => ({type: x, color})); }
function makePawnRow(color) { return Array(8).fill(null).map(() => ({type: "pawn", color})); }

// ====================
// BOARD DRAWING - SAME AS BEFORE
// ====================
function drawBoard() {
    const t = document.getElementById("board");
    t.innerHTML = "";
    for (let r = 0; r < 8; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < 8; c++) {
            const td = document.createElement("td");
            td.className = (r + c) % 2 === 0 ? "light" : "dark";
            if (selected && selected.r === r && selected.c === c)
                td.classList.add("selected");

            const p = board[r][c];
            if (p) {
                td.textContent = pieces[p.color][p.type];
                td.classList.add(p.color + "-piece");
            }
            td.onclick = () => onClick(r, c);
            tr.appendChild(td);
        }
        t.appendChild(tr);
    }
}

// ====================
// GAME LOGIC - SAME AS BEFORE
// ====================
function onClick(r, c) {
    if (gameOver) return;
    
    // In multiplayer, only allow moves when it's your turn
    if (isMultiplayer) {
        if (currentPlayer !== playerColor) {
            alert("Wait for your opponent's move!");
            return;
        }
    }
    
    const p = board[r][c];
    if (selected) {
        const moves = getValidMoves(selected.r, selected.c);
        if (moves.some(m => m.r === r && m.c === c)) {
            move(selected.r, selected.c, r, c);
            selected = null;
        } else {
            selected = (p && p.color === currentPlayer) ? {r, c} : null;
        }
    } else {
        if (p && p.color === currentPlayer) selected = {r, c};
    }
    drawBoard();
}

function move(fr, fc, tr, tc) {
    // Save to history for undo
    history.push({
        board: JSON.parse(JSON.stringify(board)),
        currentPlayer: currentPlayer,
        whiteMoves: whiteMoves,
        blackMoves: blackMoves
    });
    
    // Make the move
    board[tr][tc] = board[fr][fc];
    board[fr][fc] = null;
    
    // Update counters and player
    currentPlayer === "white" ? whiteMoves++ : blackMoves++;
    currentPlayer = currentPlayer === "white" ? "black" : "white";
    
    // If multiplayer, send move to opponent
    if (isMultiplayer && conn) {
        sendMoveToOpponent(fr, fc, tr, tc);
    }
    
    updateInfo();
    checkState();
}

function undoMove() {
    if (history.length > 0) {
        const lastState = history.pop();
        board = lastState.board;
        currentPlayer = lastState.currentPlayer;
        whiteMoves = lastState.whiteMoves;
        blackMoves = lastState.blackMoves;
        selected = null;
        drawBoard();
        updateInfo();
        document.getElementById("check-status").textContent = "";
        
        // If multiplayer, notify opponent
        if (isMultiplayer && conn) {
            conn.send({type: 'undo'});
        }
    }
}

function updateInfo() {
    document.getElementById("game-info").textContent =
        (currentPlayer === "white" ? "White" : "Black") + "'s Turn";
    document.getElementById("white-moves").textContent = "White Moves: " + whiteMoves;
    document.getElementById("black-moves").textContent = "Black Moves: " + blackMoves;
}

function updatePlayerInfo() {
    document.getElementById("player-you").textContent = "You: " + 
        (isMultiplayer ? playerColor.charAt(0).toUpperCase() + playerColor.slice(1) : "White");
    document.getElementById("player-opponent").textContent = "Opponent: " + 
        (isMultiplayer ? 
            (playerColor === "white" ? "Black" : "White") : 
            "Black");
}

// ====================
// FIXED: CREATE CLICKABLE LINK
// ====================
function generateGameCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function createMultiplayerGame() {
    const gameCode = generateGameCode();
    currentGameCode = gameCode;
    
    // üî• FIX: Create a REAL clickable link
    // Get current page URL without parameters
    const baseUrl = window.location.href.split('?')[0];
    
    // Create a data URL that contains the game code
    // This creates a link that opens the same page with the game code
    shareableUrl = baseUrl + '?game=' + gameCode;
    
    // Update the clickable link
    const clickableLink = document.getElementById('clickable-game-link');
    clickableLink.href = shareableUrl;
    clickableLink.textContent = 'üéÆ CLICK HERE TO JOIN: ' + gameCode;
    
    // Update game code display
    document.getElementById('game-id-display').textContent = 'Code: ' + gameCode;
    document.getElementById('share-link-container').style.display = 'block';
    
    // Show modal with options
    showModalWithCode(gameCode, shareableUrl);
    
    // Initialize connection
    initializePeerAsHost(gameCode);
}

// ====================
// MODAL FUNCTIONS
// ====================
function showModalWithCode(code, url) {
    const modal = document.getElementById("connection-modal");
    const contentArea = document.getElementById("modal-content-area");
    
    contentArea.innerHTML = `
        <div>Share this with your friend:</div>
        <div class="code-display">${code}</div>
        
        <div style="margin: 15px 0; text-align: center;">
            <a href="${url}" class="share-link" target="_blank" 
               style="display: block; padding: 12px; font-size: 16px;">
               üéØ DIRECT JOIN LINK
            </a>
            <div style="font-size: 12px; color: #aaa; margin-top: 5px;">
                Your friend just clicks this!
            </div>
        </div>
        
        <div>Or share via:</div>
        <div class="share-buttons">
            <button class="share-btn whatsapp" onclick="shareViaWhatsApp('${url}')">WhatsApp</button>
            <button class="share-btn telegram" onclick="shareViaTelegram('${url}')">Telegram</button>
            <button class="share-btn copy" onclick="copyToClipboard('${url}')">Copy Link</button>
        </div>
        
        <div style="margin-top: 15px; font-size: 12px; color: #aaa; padding: 10px; background: #2a2d44; border-radius: 5px;">
            <strong>How it works:</strong><br>
            1. Send the link to your friend<br>
            2. They click it and game opens<br>
            3. They automatically join your game
        </div>
    `;
    
    modal.style.display = 'flex';
}

function showJoinModal() {
    const modal = document.getElementById("connection-modal");
    const contentArea = document.getElementById("modal-content-area");
    
    contentArea.innerHTML = `
        <div>Enter your friend's 6-digit code:</div>
        <input type="text" class="code-input" id="join-code-input" maxlength="6" placeholder="ABC123">
        <button class="btn" onclick="joinMultiplayerGame()" style="margin-top: 10px;">Connect</button>
        <div style="margin-top: 15px; font-size: 12px; color: #aaa;">
            Or just click the link your friend sends you
        </div>
    `;
    
    modal.style.display = 'flex';
    document.getElementById("join-code-input").focus();
}

function hideModal() {
    document.getElementById("connection-modal").style.display = 'none';
}

// ====================
// SHARE FUNCTIONS
// ====================
function shareViaWhatsApp(url = null) {
    const shareUrl = url || shareableUrl || window.location.href;
    const text = "üéÆ Join my chess game! Click here: " + shareUrl;
    window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
}

function shareViaTelegram(url = null) {
    const shareUrl = url || shareableUrl || window.location.href;
    const text = "üéÆ Join my chess game! " + shareUrl;
    window.open('https://t.me/share/url?url=' + encodeURIComponent(shareUrl) + '&text=' + encodeURIComponent(text), '_blank');
}

function copyShareLink() {
    const link = shareableUrl || window.location.href;
    copyToClipboard(link);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("‚úÖ Link copied! Send it to your friend.");
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        alert("‚úÖ Link copied!");
    });
}

// ====================
// AUTO-JOIN FROM LINK
// ====================
function checkUrlForGameCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const gameCode = urlParams.get('game');
    
    if (gameCode && gameCode.length === 6) {
        // Auto-join the game
        currentGameCode = gameCode.toUpperCase();
        
        // Show join modal with code pre-filled
        setTimeout(() => {
            showJoinModal();
            document.getElementById('join-code-input').value = currentGameCode;
            
            // Auto-connect after 2 seconds
            setTimeout(() => {
                if (confirm("Join game with code: " + currentGameCode + "?")) {
                    joinMultiplayerGame();
                }
            }, 2000);
        }, 1000);
    }
}

// ====================
// PEERJS FUNCTIONS (SAME AS BEFORE)
// ====================
function initializePeerAsHost(gameCode) {
    try {
        peer = new Peer(gameCode);
        
        peer.on('open', function(id) {
            console.log('Host peer connected with ID:', id);
            document.getElementById("connection-status").textContent = "Waiting for opponent...";
            document.getElementById("connection-status").className = "connection-status";
        });
        
        peer.on('connection', function(connection) {
            conn = connection;
            
            conn.on('open', function() {
                console.log('Connection established with opponent');
                isMultiplayer = true;
                playerColor = "white";
                
                document.getElementById("connection-status").textContent = "Connected to opponent!";
                document.getElementById("connection-status").className = "connection-status connected";
                hideModal();
                
                conn.send({
                    type: 'init',
                    board: board,
                    currentPlayer: currentPlayer,
                    playerColor: "black"
                });
                
                updatePlayerInfo();
            });
            
            conn.on('data', function(data) {
                handleOpponentData(data);
            });
            
            conn.on('close', function() {
                document.getElementById("connection-status").textContent = "Opponent disconnected";
                document.getElementById("connection-status").className = "connection-status disconnected";
                isMultiplayer = false;
            });
        });
        
        peer.on('error', function(err) {
            console.error('Peer error:', err);
        });
        
    } catch (error) {
        console.error('Error initializing PeerJS:', error);
    }
}

function joinMultiplayerGame() {
    const gameCode = document.getElementById("join-code-input").value.trim().toUpperCase();
    
    if (!gameCode || gameCode.length !== 6) {
        alert("Please enter a valid 6-letter code (like ABC123)");
        return;
    }
    
    currentGameCode = gameCode;
    hideModal();
    
    try {
        peer = new Peer();
        
        peer.on('open', function(id) {
            console.log('Client peer connected with ID:', id);
            
            conn = peer.connect(gameCode);
            
            conn.on('open', function() {
                console.log('Connected to host');
                document.getElementById("connection-status").textContent = "Connected to host!";
                document.getElementById("connection-status").className = "connection-status connected";
            });
            
            conn.on('data', function(data) {
                handleOpponentData(data);
            });
            
            conn.on('close', function() {
                document.getElementById("connection-status").textContent = "Host disconnected";
                document.getElementById("connection-status").className = "connection-status disconnected";
                isMultiplayer = false;
            });
        });
        
        peer.on('error', function(err) {
            console.error('Peer error:', err);
            alert("Could not connect to game. Please check the code and try again.");
        });
        
    } catch (error) {
        console.error('Error connecting to game:', error);
        alert("Connection error. Please try again.");
    }
}

function sendMoveToOpponent(fr, fc, tr, tc) {
    if (conn && conn.open) {
        conn.send({
            type: 'move',
            from: {r: fr, c: fc},
            to: {r: tr, c: tc},
            board: board,
            currentPlayer: currentPlayer
        });
    }
}

function handleOpponentData(data) {
    switch(data.type) {
        case 'init':
            board = data.board;
            playerColor = data.playerColor;
            isMultiplayer = true;
            drawBoard();
            updateInfo();
            updatePlayerInfo();
            break;
            
        case 'move':
            const {from, to} = data;
            board[to.r][to.c] = board[from.r][from.c];
            board[from.r][from.c] = null;
            currentPlayer = data.currentPlayer;
            
            if (currentPlayer === "white") {
                blackMoves++;
            } else {
                whiteMoves++;
            }
            
            selected = null;
            drawBoard();
            updateInfo();
            checkState();
            break;
            
        case 'undo':
            if (history.length > 0) {
                history.pop();
            }
            break;
            
        case 'gameover':
            document.getElementById("winner-text").textContent = data.winner + " WINS";
            document.getElementById("trophy-overlay").style.display = "flex";
            gameOver = true;
            break;
    }
}

// ====================
// LOAD PEERJS AND INITIALIZE
// ====================
function loadPeerJS() {
    if (typeof Peer === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js';
        script.onload = function() {
            console.log('PeerJS loaded successfully');
            checkUrlForGameCode();
        };
        script.onerror = function() {
            console.warn('PeerJS failed to load');
            checkUrlForGameCode();
        };
        document.head.appendChild(script);
    } else {
        checkUrlForGameCode();
    }
}

// ====================
// CHESS LOGIC (UNCHANGED)
// ====================
function checkState() {
    const s = document.getElementById("check-status");
    if (isKingInCheck(currentPlayer)) {
        if (isCheckmate(currentPlayer)) {
            const winner = currentPlayer === "white" ? "BLACK" : "WHITE";
            document.getElementById("winner-text").textContent = winner + " WINS";
            document.getElementById("trophy-overlay").style.display = "flex";
            gameOver = true;
            s.textContent = "";
            
            if (isMultiplayer && conn) {
                conn.send({type: 'gameover', winner: winner});
            }
        } else {
            s.textContent = "CHECK!";
        }
    } else {
        s.textContent = "";
    }
}

function findKing(color) {
    for (let r = 0; r < 8; r++)
        for (let c = 0; c < 8; c++)
            if (board[r][c]?.type === "king" && board[r][c].color === color)
                return {r, c};
    return null;
}

function isKingInCheck(color) {
    const k = findKing(color);
    if (!k) return false;
    return isSquareAttacked(k.r, k.c, color === "white" ? "black" : "white");
}

function isCheckmate(color) {
    for (let r = 0; r < 8; r++)
        for (let c = 0; c < 8; c++) {
            const p = board[r][c];
            if (p && p.color === color && getValidMoves(r, c).length > 0)
                return false;
        }
    return true;
}

function isSquareAttacked(r, c, by) {
    for (let i = 0; i < 8; i++)
        for (let j = 0; j < 8; j++) {
            const p = board[i][j];
            if (p && p.color === by) {
                if (getPseudoMoves(i, j).some(m => m.r === r && m.c === c))
                    return true;
            }
        }
    return false;
}

function getValidMoves(r, c) {
    const p = board[r][c];
    const pseudoMoves = getPseudoMoves(r, c);
    return pseudoMoves.filter(m => {
        const originalPiece = board[r][c];
        const targetPiece = board[m.r][m.c];
        
        board[m.r][m.c] = originalPiece;
        board[r][c] = null;
        
        const inCheck = isKingInCheck(p.color);
        
        board[r][c] = originalPiece;
        board[m.r][m.c] = targetPiece;
        
        return !inCheck;
    });
}

function getPseudoMoves(r, c) {
    const p = board[r][c];
    if (!p) return [];
    if (p.type === "pawn") return pawnMoves(r, c, p.color);
    if (p.type === "rook") return slide(r, c, [[1, 0], [-1, 0], [0, 1], [0, -1]]);
    if (p.type === "bishop") return slide(r, c, [[1, 1], [1, -1], [-1, 1], [-1, -1]]);
    if (p.type === "queen") return slide(r, c, 
        [[1, 0], [-1, 0], [0, 1], [0, -1], [1, 1], [1, -1], [-1, 1], [-1, -1]]);
    if (p.type === "knight") return knight(r, c, p.color);
    if (p.type === "king") return king(r, c, p.color);
    return [];
}

function pawnMoves(r, c, color) {
    const dir = color === "white" ? -1 : 1;
    const start = color === "white" ? 6 : 1;
    const res = [];
    
    if (inBounds(r + dir, c) && !board[r + dir][c]) {
        res.push({r: r + dir, c});
        if (r === start && !board[r + 2 * dir][c]) {
            res.push({r: r + 2 * dir, c});
        }
    }
    
    for (const dc of [-1, 1]) {
        const nr = r + dir, nc = c + dc;
        if (inBounds(nr, nc) && board[nr][nc] && board[nr][nc].color !== color) {
            res.push({r: nr, c: nc});
        }
    }
    
    return res;
}

function slide(r, c, dirs) {
    const res = [];
    const color = board[r][c].color;
    
    for (const [d1, d2] of dirs) {
        let nr = r + d1, nc = c + d2;
        while (inBounds(nr, nc)) {
            if (!board[nr][nc]) {
                res.push({r: nr, c: nc});
            } else {
                if (board[nr][nc].color !== color) {
                    res.push({r: nr, c: nc});
                }
                break;
            }
            nr += d1;
            nc += d2;
        }
    }
    return res;
}

function knight(r, c, color) {
    const moves = [[2, 1], [2, -1], [-2, 1], [-2, -1], [1, 2], [1, -2], [-1, 2], [-1, -2]];
    const res = [];
    
    for (const [dr, dc] of moves) {
        const nr = r + dr, nc = c + dc;
        if (inBounds(nr, nc) && (!board[nr][nc] || board[nr][nc].color !== color)) {
            res.push({r: nr, c: nc});
        }
    }
    return res;
}

function king(r, c, color) {
    const res = [];
    for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
            if (dr === 0 && dc === 0) continue;
            const nr = r + dr, nc = c + dc;
            if (inBounds(nr, nc) && (!board[nr][nc] || board[nr][nc].color !== color)) {
                res.push({r: nr, c: nc});
            }
        }
    }
    return res;
}

function inBounds(r, c) {
    return r >= 0 && r < 8 && c >= 0 && c < 8;
}

// ====================
// INITIALIZE GAME
// ====================
loadPeerJS();
initBoard();
</script>
</body>
</html>